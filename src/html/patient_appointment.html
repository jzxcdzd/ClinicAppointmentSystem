<!--
TODO: implement debug tables
- table for past appointments
- table for physician list

use this table for data instead of predefined values
replace with database code when available
-->

<html>
    <head>
        <title>Patient Appointment</title>
        <!-- Bootstrap CSS CDN -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Link to external CSS -->
        <link rel="stylesheet" href="../css/index.css">
    </head>
    <body>
        <div class="container mt-4">
            <h1 id="greeting" class="text-center mb-4"></h1>
            <!-- Additional appointment page content can go here -->
            <p class="text-center">Your past and upcoming appointments will be displayed here.</p>
            <div class="d-flex justify-content-center mt-3">
                <!-- Button triggers the modal -->
                <button type="button"
                        class="btn btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#appointmentModal">
                    Request for an Appointment
                </button>
            </div>
            <div class="table-responsive mt-4">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Appointment ID</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Physician-in-charge</th>
                            <th>Contact #</th>
                            <th>Chief concern</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Appointment rows go here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal for requesting an appointment -->
        <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="appointmentModalLabel">Request Appointment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Please note that incomplete forms and appointments outside of schedule hours will not be entertained.</p>
                        <form id="appointmentForm">
                            <!-- Physician-in-charge moved to the top -->
                            <div class="mb-3">
                                <label for="physician" class="form-label">Physician-in-charge</label>
                                <select class="form-select" id="physician" name="physician">
                                    <option selected>Choose...</option>
                                    <option value="1">Dr. Algarra</option>
                                    <option value="2">Dr. Macariola</option>
                                    <option value="3">Dr. Santiago</option>
                                </select>
                                <div id="scheduleDisplay" class="mt-2"></div>
                            </div>
                            <div class="mb-3">
                                <label for="appointmentDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="appointmentDate" name="appointmentDate">
                            </div>
                            <div class="mb-3">
                                <label for="appointmentTime" class="form-label">Time</label>
                                <input type="time" class="form-control" id="appointmentTime" name="appointmentTime">
                            </div>
                            <div class="mb-3">
                                <label for="chiefConcern" class="form-label">Chief Concern</label>
                                <textarea class="form-control" id="chiefConcern" name="chiefConcern" rows="3"></textarea>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">Submit Request</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script type="module">
            import { PhysicianDB } from '../js/physicianDb.js';
            import { AppointmentDB } from '../js/appointmentsDb.js';
        
            // Retrieve firstName and lastName from URL query parameters
            const params = new URLSearchParams(window.location.search);
            const firstName = params.get('firstName');
            const lastName = params.get('lastName');
            const patientId = parseInt(params.get('patientId')); // Get patientId from query params
        
            const greetingElem = document.getElementById('greeting');
            if (firstName && lastName) {
                greetingElem.textContent = `Good day, ${firstName} ${lastName}!`;
            } else {
                greetingElem.textContent = 'Good day!';
            }
        
            // Populate physician dropdown with data from physicianDb.js
            const physicianSelect = document.getElementById('physician');
            const scheduleDisplay = document.getElementById('scheduleDisplay');
        
            // Clear any existing options (like "Choose...")
            physicianSelect.innerHTML = '<option selected value="">Choose...</option>';
        
            // Fill the dropdown from the physicians array
            PhysicianDB.getAll().forEach((phys) => {
                const option = document.createElement('option');
                option.value = phys.id;
                option.textContent = phys.name;
                physicianSelect.appendChild(option);
            });
        
            // Listen for changes on the physician selection and display schedule text from physicianDb.js
            physicianSelect.addEventListener('change', function() {
                // Get selected physician with validation
                const selectedPhys = PhysicianDB.getById(parseInt(this.value));
                if (!selectedPhys) {
                    scheduleDisplay.textContent = 'Physician not found';
                    return;
                }
        
                // Display schedule information
                let scheduleText = '<strong>Availability:</strong><br>';
                Object.entries(selectedPhys.schedule).forEach(([day, details]) => {
                    if (details.available) {
                        scheduleText += `- ${day}: ${details.hours.start} - ${details.hours.end}<br>`;
                    } else {
                        scheduleText += `- ${day}: Unavailable<br>`;
                    }
                });
                scheduleDisplay.innerHTML = scheduleText;
            });
        
            // Limit dates to today and future dates only
            const appointmentDateInput = document.getElementById('appointmentDate');
            const today = new Date().toISOString().split("T")[0];
            appointmentDateInput.min = today;
        
            // Submission handler
            document.getElementById("appointmentForm").addEventListener("submit", function(event) {
                event.preventDefault();
        
                // Retrieve values from the form inputs
                const appointmentTimeInput = document.getElementById('appointmentTime');
                const chiefConcernInput = document.getElementById('chiefConcern');
        
                // Validate that all required fields are filled
                if (!appointmentDateInput.value || !appointmentTimeInput.value || !physicianSelect.value || !chiefConcernInput.value.trim()) {
                    alert("Please fill in all fields.");
                    return;
                }
        
                // Create a new appointment object
                const newAppointment = {
                    date: appointmentDateInput.value,
                    time: appointmentTimeInput.value,
                    patientId: patientId, // Use the patientId from the query params
                    physicianId: parseInt(physicianSelect.value),
                    chiefConcern: chiefConcernInput.value.trim(),
                    notes: "" // Notes can be added later
                };
        
                // Add the new appointment to the database
                const addedAppointment = AppointmentDB.add(newAppointment);
        
                // Update the table with the new appointment
                const tbody = document.querySelector("table.table tbody");
                const newRow = document.createElement("tr");
                newRow.innerHTML = `
                    <td>${addedAppointment.id}</td>
                    <td>${addedAppointment.date}</td>
                    <td>${addedAppointment.time}</td>
                    <td>${PhysicianDB.getById(addedAppointment.physicianId).name}</td>
                    <td>N/A</td>
                    <td>${addedAppointment.chiefConcern}</td>
                    <td>${addedAppointment.notes}</td>
                `;
                tbody.appendChild(newRow);
        
                // Reset the form and clear the schedule display
                event.target.reset();
                scheduleDisplay.textContent = "";
        
                // Hide the modal using Bootstrap's Modal API
                const appointmentModalEl = document.getElementById("appointmentModal");
                const modalInstance = bootstrap.Modal.getInstance(appointmentModalEl);
                modalInstance.hide();
        
                alert("Appointment successfully added!");
            });
        
            // Load existing appointments for the patient
            const loadAppointments = () => {
                const tbody = document.querySelector("table.table tbody");
                tbody.innerHTML = ""; // Clear existing rows
        
                const patientAppointments = AppointmentDB.getByPatientId(patientId);
                patientAppointments.forEach((appointment) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${appointment.id}</td>
                        <td>${appointment.date}</td>
                        <td>${appointment.time}</td>
                        <td>${PhysicianDB.getById(appointment.physicianId).name}</td>
                        <td>N/A</td>
                        <td>${appointment.chiefConcern}</td>
                        <td>${appointment.notes}</td>
                    `;
                    tbody.appendChild(row);
                });
            };
        
            // Load appointments on page load
            loadAppointments();
        </script>
    </body>
</html>