<!--

PATIENT LOGIN PAGE
contains the form for patient login info
info will be cross-checked with the database

if certain info matches (non-case sensitive):
first name && last name && birthdate
this means patient is already registered
so proceed to patient_appointment.html and use data from matched patient
should proceed even when other info is not filled out

if the 3 info does not match then patient is new
will auto register & create entry in patientDb
and then proceed to patient_appointment.html
as long as all info are filled out else, "error: please fill out all fields"

clicking submit will take you to patient_appointment.html

-->

<html>
    <head>
        <title>Patient Login</title>
        <!-- Bootstrap CSS CDN -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Link to external CSS -->
        <link rel="stylesheet" href="../css/index.css">
    </head>
    <body>
        <div class="container mt-4">
            <h1 class="text-center mb-4">Patient Login</h1>
            <p style="font-size:12px;">
                Note: <br>
                If you are a returning patient, 
                please make sure that your full name & birthdate are accurate 
                to ensure that your information is retrieved correctly. <br>
                <i>
                Kung ikaw ay isang bumabalik na pasyente,
                mangyaring tiyakin na ang iyong buong pangalan at petsa ng kapanganakan ay tama 
                upang matiyak na ang iyong impormasyon ay nakuha nang tama.
                </i>
            </p>
            <form id="patientLoginForm">
                <div class="mb-3">
                    <label for="firstName" class="form-label">First Name</label>
                    <input type="text" class="form-control" id="firstName" name="firstName" required>
                </div>
                <div class="mb-3">
                    <label for="middleName" class="form-label">Middle Name</label>
                    <input type="text" class="form-control" id="middleName" name="middleName">
                </div>
                <div class="mb-3">
                    <label for="lastName" class="form-label">Last Name</label>
                    <input type="text" class="form-control" id="lastName" name="lastName" required>
                </div>
                <div class="mb-3">
                    <label for="birthdate" class="form-label">Birthdate</label>
                    <input type="date" class="form-control" id="birthdate" name="birthdate" required>
                </div>
                <div class="mb-3">
                    <label for="sex" class="form-label">Sex</label>
                    <select class="form-select" id="sex" name="sex">
                        <option selected>Choose...</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Address</label>
                    <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label for="mobileNumber" class="form-label">Mobile Number</label>
                    <input type="tel" class="form-control" id="mobileNumber" name="mobileNumber">
                </div>
                <div class="mb-3">
                    <label for="emailAddress" class="form-label">E-mail</label>
                    <input type="email" class="form-control" id="emailAddress" name="emailAddress">
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">Submit</button>
                </div>
            </form>
            <div class="text-center">
                <button type="button" id="debugSkipLogin" class="btn btn-danger btn-skiplgn" onclick="skipLogin();">Debug: Skip Log In</button>
            </div>
        </div>

        <!-- Bootstrap JS (optional) & dependencies -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script type="module">
            import { PatientDB } from '../js/patientDb.js';
        
            document.getElementById('patientLoginForm').addEventListener('submit', function(event) {
                event.preventDefault();
        
                // Get form values
                const firstNameInput = document.getElementById('firstName').value.trim();
                const lastNameInput = document.getElementById('lastName').value.trim();
                const birthdate = document.getElementById('birthdate').value.trim();
                const middleName = document.getElementById('middleName').value.trim();
                const sex = document.getElementById('sex').value;
                const address = document.getElementById('address').value.trim();
                const mobileNumber = document.getElementById('mobileNumber').value.trim();
                const emailAddress = document.getElementById('emailAddress').value.trim();
        
                // Use lowercased values for comparison only
                const firstNameLower = firstNameInput.toLowerCase();
                const lastNameLower = lastNameInput.toLowerCase();
        
                // Check if patient is already registered
                const existingPatient = PatientDB.getAll().find(patient =>
                    patient.name.first.toLowerCase() === firstNameLower &&
                    patient.name.last.toLowerCase() === lastNameLower &&
                    patient.birthdate === birthdate
                );
        
                if (existingPatient) {
                    // Existing patient found
                    alert('Welcome back! Redirecting to appointment page...');
                    const params = new URLSearchParams({
                        firstName: existingPatient.name.first,
                        lastName: existingPatient.name.last,
                        patientId: existingPatient.id
                    });
                    window.location.href = `patient_appointment.html?${params.toString()}`;
                } else {
                    // Validate required fields for new patient registration
                    if (!firstNameInput || !lastNameInput || !birthdate || !sex || !address || !mobileNumber || !emailAddress) {
                        alert('Error: Please fill out all fields.');
                        return;
                    }
        
                    // Register new patient with original input values
                    const newPatient = {
                        name: {
                            first: firstNameInput,
                            middle: middleName,
                            last: lastNameInput
                        },
                        birthdate,
                        sex,
                        address,
                        mobile: mobileNumber,
                        email: emailAddress
                    };
        
                    const addedPatient = PatientDB.add(newPatient);
        
                    alert('New patient registered! Redirecting to appointment page...');
                    const params = new URLSearchParams({
                        firstName: addedPatient.name.first,
                        lastName: addedPatient.name.last,
                        patientId: addedPatient.id
                    });
                    window.location.href = `patient_appointment.html?${params.toString()}`;
                }
            });

            function skipLogin() {
                const params = new URLSearchParams({
                    firstName: 'Jose Miguel',
                    lastName: 'Custodio',
                    patientId: 1
                });
                window.location.href = `patient_appointment.html?${params.toString()}`;
            }
            window.skipLogin = skipLogin;

        </script>
    </body>
</html>