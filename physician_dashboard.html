<!DOCTYPE html>
<html data-bs-theme="light" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />
    <title>Physician Dashboard</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/css/animate.min.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="assets/css/index.css" />
    <link rel="stylesheet" href="assets/css/Hero-Clean-images.css" />
    <link rel="stylesheet" href="assets/css/Navbar-Right-Links-icons.css" />
    <link rel="stylesheet" href="assets/css/physician_dashboard.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <link rel="stylesheet" href="assets/css/animate.min.css" />
  </head>

  <body>
    <nav class="navbar navbar-expand-md bg-body py-3">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#"
          ><span
            class="bs-icon-sm bs-icon-rounded bs-icon-primary d-flex justify-content-center align-items-center me-2 bs-icon"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-hospital"
              viewBox="0 0 16 16"
            >
              <path
                d="M8.5 5.034v1.1l.953-.55.5.867L9 7l.953.55-.5.866-.953-.55v1.1h-1v-1.1l-.953.55-.5-.866L7 7l-.953-.55.5-.866.953.55v-1.1zM13.25 9a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25zM13 11.25a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25zm.25 1.75a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25zm-11-4a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5A.25.25 0 0 0 3 9.75v-.5A.25.25 0 0 0 2.75 9zm0 2a.25.25 0 0 0-.25.25v.5c0 .138.112.25.25.25h.5a.25.25 0 0 0 .25-.25v-.5a.25.25 0 0 0-.25-.25zM2 13.25a.25.25 0 0 1 .25-.25h.5a.25.25 0 0 1 .25.25v.5a.25.25 0 0 1-.25.25h-.5a.25.25 0 0 1-.25-.25z"
              />
              <path
                d="M5 1a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v1a1 1 0 0 1 1 1v4h3a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1h3V3a1 1 0 0 1 1-1zm2 14h2v-3H7zm3 0h1V3H5v12h1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1zm0-14H6v1h4zm2 7v7h3V8zm-8 7V8H1v7z"
              /></svg></span
          ><span><strong>Aremcee Medical Center</strong></span></a
        ><button
          data-bs-toggle="collapse"
          class="navbar-toggler"
          data-bs-target="#navcol-3"
        >
          <span class="visually-hidden">Toggle navigation</span
          ><span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navcol-3">
          <ul class="navbar-nav mx-auto">
            <li class="nav-item"></li>
            <li class="nav-item"></li>
            <li class="nav-item"></li>
          </ul>
          <button
            class="btn btn-primary"
            data-bss-hover-animate="pulse"
            type="button"
            onclick="window.location.href='index.html';"
          >
            <strong>Back to Home</strong>
          </button>
        </div>
      </div>
    </nav>
    <div class="container mt-4">
      <div class="d-flex justify-content-center align-items-center mb-3">
        <h1 id="greeting" class="mb-0"></h1>
      </div>
      <p class="text-center">
        Your upcoming appointments and patient details will be displayed here.
      </p>
      <div class="d-flex justify-content-center gap-3 mt-3">
        <button
          class="btn btn-primary"
          data-bss-hover-animate="pulse"
          type="button"
          data-bs-toggle="modal"
          data-bs-target="#appointmentModal"
        >
          <strong> Add New Appointment </strong></button
        ><button
          class="btn btn-primary"
          data-bss-hover-animate="pulse"
          type="button"
          data-bs-toggle="modal"
          data-bs-target="#editPhysicianModal"
        >
          <i class="bi bi-pencil-square"></i><strong> Edit Information </strong>
        </button>
      </div>
      <div class="table-responsive mt-4">
        <table class="table table-hover table-sm">
          <thead>
            <tr>
              <th class="col-id">ID</th>
              <th class="col-date">Date</th>
              <th class="col-time">Time</th>
              <th class="col-patient">Patient Name</th>
              <th class="col-contact">Contact #</th>
              <th class="col-chief-concern">Chief Concern</th>
              <th class="col-notes">Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="appointmentCalendar" class="mt-4"></div>
    </div>

    <footer class="text-center py-4">
      <div class="container">
        <div class="row row-cols-1 row-cols-lg-3">
          <div class="col">
            <p class="text-muted my-2">
              LBYCPG3 - EQ2 | Clinic Appointment System
            </p>
          </div>
          <div class="col"></div>
          <div class="col">
            <p class="text-muted my-2">Santiago, Macariola, Algarra</p>
          </div>
        </div>
      </div>
    </footer>
    <div
      class="modal fade"
      role="dialog"
      tabindex="-1"
      id="appointmentModal"
      aria-labelledby="appointmentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="appointmentModalLabel">
              Add Appointment
            </h5>
            <button
              class="btn-close"
              aria-label="Close"
              data-bs-dismiss="modal"
              type="button"
            ></button>
          </div>
          <div class="modal-body">
            <form id="appointmentForm">
              <input type="hidden" id="appointmentId" name="appointmentId" />
              <div class="row mb-2">
                <div class="col-md-10">
                  <label class="form-label" for="patientName"
                    >Patient Name</label
                  ><input
                    class="form-control form-control"
                    type="text"
                    id="patientName"
                    name="patientName"
                    readonly=""
                  />
                </div>
                <div class="col-md-2">
                  <label class="form-label" for="patientId">ID</label
                  ><input
                    class="form-control form-control"
                    type="text"
                    id="patientId"
                    name="patientId"
                    required=""
                  />
                </div>
              </div>
              <div class="mb-2">
                <label class="form-label" for="patientContact"
                  >Patient Contact</label
                ><input
                  class="form-control form-control"
                  type="text"
                  id="patientContact"
                  name="patientContact"
                  readonly=""
                  required=""
                />
              </div>
              <div class="row mb-2">
                <div class="col-md-6">
                  <label class="form-label" for="appointmentDate">Date</label
                  ><input
                    class="form-control form-control"
                    id="appointmentDate"
                    name="appointmentDate"
                    required=""
                    type="date"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="appointmentTime">Time</label>
                  <select
                    class="form-select"
                    id="appointmentTime"
                    name="appointmentTime"
                    required=""
                  >
                    <option value="" selected>Choose...</option>
                  </select>
                </div>
              </div>
              <div class="mb-2">
                <label class="form-label" for="chiefConcern"
                  >Chief Concern</label
                ><textarea
                  class="form-control form-control"
                  id="chiefConcern"
                  name="chiefConcern"
                  required=""
                  rows="3"
                ></textarea>
              </div>
              <div class="mb-2">
                <label class="form-label" for="notes">Notes</label
                ><textarea
                  class="form-control form-control"
                  id="notes"
                  name="notes"
                  rows="3"
                ></textarea>
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-primary" type="submit">
                  Save Appointment</button
                ><button
                  class="btn btn-danger"
                  id="deleteAppointmentButton"
                  style="display: none"
                  type="button"
                >
                  Delete Appointment
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      role="dialog"
      tabindex="-1"
      id="editPhysicianModal"
      aria-labelledby="editPhysicianModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editPhysicianModalLabel">
              Edit Physician Information
            </h5>
            <button
              class="btn-close"
              aria-label="Close"
              data-bs-dismiss="modal"
              type="button"
            ></button>
          </div>
          <div class="modal-body">
            <form id="physicianInfoForm">
              <div class="mb-3">
                <label class="form-label" for="physicianName">Full Name</label
                ><input
                  class="form-control form-control"
                  type="text"
                  id="physicianName"
                  name="physicianName"
                  required=""
                />
              </div>
              <div class="mb-3">
                <label class="form-label" for="physicianSpecialty"
                  >Specialty</label
                ><select
                  class="form-select form-select"
                  id="physicianSpecialty"
                  name="physicianSpecialty"
                  required=""
                >
                  <option value="Cardiology">Cardiology</option>
                  <option value="Pediatrics">Pediatrics</option>
                  <option value="Neurology">Neurology</option>
                  <option value="Dermatology">Dermatology</option>
                  <option value="Orthopedics">Orthopedics</option>
                  <option value="General Medicine">General Medicine</option>
                  <option value="Gynecology">Gynecology</option>
                  <option value="Ophthalmology">Ophthalmology</option>
                  <option value="Psychiatry">Psychiatry</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label" for="physicianBio">Bio</label
                ><textarea
                  class="form-control form-control"
                  id="physicianBio"
                  name="physicianBio"
                  rows="3"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label" for="physicianContact"
                  >Contact Number</label
                ><input
                  class="form-control form-control"
                  type="text"
                  id="physicianContact"
                  name="physicianContact"
                  required=""
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Weekly Schedule</label>
                <div class="schedule-container"></div>
              </div>
              <div class="mb-3">
                <label class="form-label" for="physicianUsername"
                  >Username</label
                ><input
                  class="form-control form-control"
                  type="text"
                  id="physicianUsername"
                  name="physicianUsername"
                  required=""
                />
              </div>
              <div class="mb-3">
                <label class="form-label" for="physicianPassword"
                  >Password</label
                ><input
                  class="form-control form-control"
                  type="password"
                  id="physicianPassword"
                  name="physicianPassword"
                  placeholder="Leave blank to keep current password"
                />
                <div class="form-text">
                  <span
                    >Enter a new password only if you want to change it.</span
                  >
                </div>
              </div>
              <div class="d-grid">
                <button class="btn btn-primary" type="submit">
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { PhysicianDB } from "./assets/js/physicianDb.js";
      import { AppointmentDB } from "./assets/js/appointmentsDb.js";
      import { PatientDB } from "./assets/js/patientDb.js";

      const appointmentForm = document.getElementById("appointmentForm");
      const appointmentModalLabel = document.getElementById(
        "appointmentModalLabel"
      );
      const appointmentDateInput = document.getElementById("appointmentDate");
      const appointmentTimeInput = document.getElementById("appointmentTime");
      const patientNameInput = document.getElementById("patientName");
      const patientContactInput = document.getElementById("patientContact");
      const chiefConcernInput = document.getElementById("chiefConcern");
      const notesInput = document.getElementById("notes");
      const deleteAppointmentButton = document.getElementById(
        "deleteAppointmentButton"
      );

      const patientContact = patientContactInput.value.trim();

      const greetingElement = document.getElementById("greeting");
      const physicianId = parseInt(
        new URLSearchParams(window.location.search).get("physicianId")
      );
      const physician = PhysicianDB.getById(physicianId);
      if (physician) {
        greetingElement.textContent = `Welcome, ${physician.name}!`;
      } else {
        greetingElement.textContent = "Welcome!";
      }

      /*** HANDLES EVERYTHING ABOUT THE MODAL ***/

      const today = new Date().toISOString().split("T")[0];
      appointmentDateInput.min = today;

      // Populate time slots based on availability
      appointmentDateInput.addEventListener("change", function () {
        const selectedDate = this.value;
        const physician = PhysicianDB.getById(physicianId);

        if (!physician || !selectedDate) {
          appointmentTimeInput.innerHTML =
            '<option value="" selected>Choose...</option>';
          return;
        }

        const dayOfWeek = new Date(selectedDate).toLocaleString("en-US", {
          weekday: "long",
        });
        const schedule = physician.schedule[dayOfWeek];

        if (!schedule || !schedule.available) {
          appointmentTimeInput.innerHTML =
            '<option value="" selected>No available times</option>';
          return;
        }

        const startTime = schedule.hours.start;
        const endTime = schedule.hours.end;
        const bookedAppointments = AppointmentDB.getByPhysicianId(
          physicianId
        ).filter((appointment) => appointment.date === selectedDate);

        const availableSlots = [];
        let currentTime = new Date(`1970-01-01T${startTime}:00`);
        const endTimeDate = new Date(`1970-01-01T${endTime}:00`);

        while (currentTime < endTimeDate) {
          const timeString = currentTime.toTimeString().slice(0, 5); // Format as HH:mm
          const isBooked = bookedAppointments.some(
            (appointment) => appointment.time === timeString
          );

          if (!isBooked) {
            availableSlots.push(timeString);
          }

          currentTime.setMinutes(currentTime.getMinutes() + 30); // Increment by 30 minutes
        }

        appointmentTimeInput.innerHTML =
          '<option value="" selected>Choose...</option>';
        availableSlots.forEach((slot) => {
          const option = document.createElement("option");
          option.value = slot;
          option.textContent = slot;
          appointmentTimeInput.appendChild(option);
        });

        if (availableSlots.length === 0) {
          appointmentTimeInput.innerHTML =
            '<option value="" selected>No available times</option>';
        }
      });

      // CALENDAR INITIALIZATION FOR APPOINTMENTS
      let calendar; // Declare a global variable to store the calendar instance

      document.addEventListener("DOMContentLoaded", function () {
        const calendarEl = document.getElementById("appointmentCalendar");

        // Initialize the calendar
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth", // Month view
          headerToolbar: {
            left: "prev,next", // Navigation buttons
            center: "title", // Show the month title
            right: "", // No additional views
          },
          selectable: false, // Disable selection
          editable: false, // Disable editing
          height: "auto", // Automatically adjust height
          dayMaxEventRows: true, // Limit the number of events shown per day
          dayMaxEvents: 3, // Show a maximum of 3 events per day (adjust as needed)
          contentHeight: "auto", // Dynamically adjust the calendar height
        });

        // Synchronize the calendar with the database
        const syncCalendarWithDatabase = () => {
          // Clear all existing events from the calendar
          calendar.getEvents().forEach((event) => event.remove());

          // Fetch all appointments from the database
          const appointments = AppointmentDB.getByPhysicianId(physicianId);

          // Add each appointment as an event in the calendar
          appointments.forEach((appointment) => {
            calendar.addEvent({
              id: String(appointment.id), // Ensure the ID is consistent
              title: appointment.time,
              start: `${appointment.date}T${appointment.time}`,
              allDay: false,
            });
          });
        };

        // Call the synchronization function
        syncCalendarWithDatabase();

        // Render the calendar
        calendar.render();
      });

      /*** HANDLES ADD NEW APPOINTMENT BUTTON ***/

      const addAppointmentButton = document.querySelector(
        '[data-bs-target="#appointmentModal"]'
      );
      addAppointmentButton.addEventListener("click", () => {
        document.getElementById("appointmentId").value = "";
        appointmentModalLabel.textContent = "Add New Appointment";
        appointmentDateInput.value = "";
        appointmentTimeInput.value = "";
        patientNameInput.value = "";
        patientId.value = "";
        patientContactInput.value = "";
        chiefConcernInput.value = "";
        notesInput.value = "";
        deleteAppointmentButton.style.display = "none";
        patientId.removeAttribute("readonly");
        setupEditMode(false);
      });

      const patientIdInput = document.getElementById("patientId");

      patientIdInput.addEventListener("input", function () {
        const patientId = parseInt(this.value.trim());
        const patient = PatientDB.getById(patientId);

        if (patient) {
          document.getElementById(
            "patientName"
          ).value = `${patient.name.first} ${patient.name.last}`;
          document.getElementById("patientContact").value = patient.mobile;
        } else {
          document.getElementById("patientName").value = "";
          document.getElementById("patientContact").value = "";
          alert("Patient not found.");
          document.getElementById("patientId").value = ""; // Clear the patientId field
        }
      });

      // HANDLES FORM SUBMISSION FOR ADDING/EDITING APPOINTMENTS
      appointmentForm.addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent the default form submission behavior

        const appointmentId = document.getElementById("appointmentId").value;
        const appointmentDate = appointmentDateInput.value;
        const appointmentTime = appointmentTimeInput.value;
        const patientId = parseInt(
          document.getElementById("patientId").value.trim()
        );
        const chiefConcern = chiefConcernInput.value.trim();
        const notes = notesInput.value.trim();

        // Validate required fields
        if (
          !appointmentDate ||
          !appointmentTime ||
          !patientId ||
          !chiefConcern
        ) {
          alert("Please fill in all required fields.");
          return;
        }

        // Check if the selected date and time are valid
        const now = new Date();
        const selectedDateTime = new Date(
          `${appointmentDate}T${appointmentTime}`
        );

        if (selectedDateTime < now) {
          alert("You cannot select a time that has already passed.");
          return;
        }

        if (appointmentId) {
          // Edit existing appointment
          const appointment = AppointmentDB.getById(parseInt(appointmentId));
          if (appointment) {
            const updatedAppointment = {
              id: appointment.id, // Ensure the id remains consistent
              date: appointmentDate,
              time: appointmentTime,
              patientId: patientId,
              physicianId: physicianId,
              chiefConcern: chiefConcern,
              notes: notes,
            };
            const updated = AppointmentDB.update(
              appointment.id,
              updatedAppointment
            );
            if (updated) {
              alert("Appointment updated successfully!");

              // Debug: Check if the event exists in the calendar
              const oldEvent = calendar.getEventById(appointment.id);
              if (oldEvent) {
                console.log("Old event found:", oldEvent);
                oldEvent.remove(); // Remove the old event
              } else {
                console.warn(
                  "Old event not found in the calendar for id:",
                  appointment.id
                );
              }

              // Add the updated event to the calendar
              calendar.addEvent({
                id: updatedAppointment.id, // Use the same id
                title: updatedAppointment.time,
                start: `${updatedAppointment.date}T${updatedAppointment.time}`,
                allDay: false,
              });
            } else {
              alert("Failed to update appointment.");
            }
          } else {
            alert("Appointment not found.");
          }
        } else {
          // Add new appointment
          const newAppointment = {
            date: appointmentDate,
            time: appointmentTime,
            patientId: patientId,
            physicianId: physicianId,
            chiefConcern: chiefConcern,
            notes: notes,
          };
          const added = AppointmentDB.add(newAppointment);
          if (added) {
            alert("Appointment added successfully!");
            // Add the new event to the calendar
            calendar.addEvent({
              id: newAppointment.id, // Use the unique ID
              title: newAppointment.time,
              start: `${newAppointment.date}T${newAppointment.time}`,
              allDay: false,
            });
          } else {
            alert("Failed to add appointment.");
          }
        }

        // Reload appointments in the table
        loadAppointments();

        // Properly hide the modal and remove the backdrop
        const modalElement = document.getElementById("appointmentModal");
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
          modalInstance.hide();
        }

        // Ensure the backdrop is removed
        document
          .querySelectorAll(".modal-backdrop")
          .forEach((backdrop) => backdrop.remove());
        document.body.classList.remove("modal-open");
        document.body.style = ""; // Reset body styles
      });

      // FUNCTION TO LOAD APPOINTMENTS INTO THE TABLE
      const loadAppointments = () => {
        const tbody = document.querySelector("table.table tbody");
        tbody.innerHTML = "";
        const appointments = AppointmentDB.getByPhysicianId(physicianId);

        appointments.forEach((appointment) => {
          const patient = PatientDB.getById(appointment.patientId);
          const patientName = patient
            ? `${patient.name.first} ${patient.name.last}`
            : "Unknown Patient";
          const patientContact = patient ? patient.mobile : "Unknown Contact";

          const row = document.createElement("tr");
          row.innerHTML = `
                            <td>${appointment.id}</td>
                            <td>${appointment.date}</td>
                            <td>${appointment.time}</td>
                            <td>${patientName}</td>
                            <td>${patientContact}</td>
                            <td>${appointment.chiefConcern}</td>
                            <td>${appointment.notes}</td>
                        `;

          // Allow editing of existing appointments by clicking the row
          row.classList.add("clickable-row");
          row.addEventListener("click", () => {
            document.getElementById("appointmentId").value = appointment.id;
            appointmentModalLabel.textContent = `Edit Appointment ID: ${appointment.id}`;
            appointmentDateInput.value = appointment.date;
            appointmentTimeInput.value = appointment.time;
            patientNameInput.value = patientName;
            patientId.value = appointment.patientId;
            patientContactInput.value = patientContact;
            chiefConcernInput.value = appointment.chiefConcern;
            notesInput.value = appointment.notes || "";
            patientId.setAttribute("readonly", true);

            deleteAppointmentButton.style.display = "block";
            setupEditMode(true);

            // Trigger the change event for the date input to populate the time dropdown
            appointmentDateInput.dispatchEvent(new Event("change"));

            deleteAppointmentButton.onclick = () => {
              const confirmDelete = confirm(
                "Are you sure you want to delete this appointment?"
              );
              if (confirmDelete) {
                AppointmentDB.delete(appointment.id);
                alert("Appointment deleted successfully!");
                loadAppointments();
                const modalInstance = bootstrap.Modal.getInstance(
                  document.getElementById("appointmentModal")
                );
                modalInstance.hide();
              }
            };

            const modalInstance = new bootstrap.Modal(
              document.getElementById("appointmentModal")
            );
            modalInstance.show();
          });
          tbody.appendChild(row);
        });
      };

      // INITIALIZE APPOINTMENTS ON PAGE LOAD
      loadAppointments();

      function setupEditMode(isEditMode) {
        // Clear any previous highlighting
        appointmentDateInput.classList.remove("editable-field");
        appointmentTimeInput.classList.remove("editable-field");
        chiefConcernInput.classList.remove("editable-field");
        notesInput.classList.remove("editable-field");
        patientNameInput.classList.remove("editable-field");
        patientContactInput.classList.remove("editable-field");

        if (isEditMode) {
          // Highlight fields that can be edited
          appointmentDateInput.classList.add("editable-field");
          appointmentTimeInput.classList.add("editable-field");
          chiefConcernInput.classList.add("editable-field");
          notesInput.classList.add("editable-field");
          patientNameInput.classList.add("editable-field");
          patientContactInput.classList.add("editable-field");

          // Make name and contact editable
          patientNameInput.removeAttribute("readonly");
          patientContactInput.removeAttribute("readonly");

          // Focus on notes as that's typically what physicians update
          notesInput.focus();

          // Change button text to indicate editing
          document.querySelector(
            '#appointmentForm button[type="submit"]'
          ).textContent = "Update Appointment";
        } else {
          // For adding new appointments
          patientNameInput.setAttribute("readonly", true);
          patientContactInput.setAttribute("readonly", true);

          document.querySelector(
            '#appointmentForm button[type="submit"]'
          ).textContent = "Save Appointment";
        }
      }

      loadAppointments();

      // Handle the physician info edit modal
      const physicianInfoForm = document.getElementById("physicianInfoForm");
      const scheduleContainer = document.querySelector(".schedule-container");

      // Function to load physician info into the form
      function loadPhysicianInfo() {
        const physician = PhysicianDB.getById(physicianId);
        if (!physician) return;

        // Populate form fields with physician data
        document.getElementById("physicianName").value = physician.name;
        document.getElementById("physicianSpecialty").value =
          physician.specialty;
        document.getElementById("physicianBio").value = physician.bio || "";
        document.getElementById("physicianContact").value = physician.contact;
        document.getElementById("physicianUsername").value = physician.username;

        // Reset schedule container
        scheduleContainer.innerHTML = "";

        // Create schedule inputs for each day of the week
        const daysOfWeek = [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
        ];

        daysOfWeek.forEach((day) => {
          const daySchedule = physician.schedule[day] || {
            available: false,
            hours: { start: "09:00", end: "17:00" },
          };

          const dayDiv = document.createElement("div");
          dayDiv.className = "card mb-2";
          dayDiv.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">${day}</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="available-${day}"
                                        ${
                                          daySchedule.available ? "checked" : ""
                                        }>
                                    <label class="form-check-label" for="available-${day}">Available</label>
                                </div>
                            </div>
                            <div class="row schedule-hours ${
                              !daySchedule.available ? "d-none" : ""
                            }">
                                <div class="col-md-6">
                                    <label class="form-label small">Start Time</label>
                                    <input type="time" class="form-control form-control-sm" id="start-${day}"
                                        value="${
                                          daySchedule.hours?.start || "09:00"
                                        }">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">End Time</label>
                                    <input type="time" class="form-control form-control-sm" id="end-${day}"
                                        value="${
                                          daySchedule.hours?.end || "17:00"
                                        }">
                                </div>
                            </div>
                        </div>
                    `;

          scheduleContainer.appendChild(dayDiv);

          // Add event listener for the availability toggle
          const availableCheckbox = dayDiv.querySelector(`#available-${day}`);
          const scheduleHours = dayDiv.querySelector(".schedule-hours");

          availableCheckbox.addEventListener("change", function () {
            if (this.checked) {
              scheduleHours.classList.remove("d-none");
            } else {
              scheduleHours.classList.add("d-none");
            }
          });
        });
      }

      // Handle form submission for updating physician info
      physicianInfoForm.addEventListener("submit", function (event) {
        event.preventDefault();

        const name = document.getElementById("physicianName").value.trim();
        const specialty = document.getElementById("physicianSpecialty").value;
        const bio = document.getElementById("physicianBio").value.trim();
        const contact = document
          .getElementById("physicianContact")
          .value.trim();
        const username = document
          .getElementById("physicianUsername")
          .value.trim();
        const password = document.getElementById("physicianPassword").value;

        // Validate required fields
        if (!name || !specialty || !contact || !username) {
          alert("Please fill in all required fields.");
          return;
        }

        // Build the updated schedule object
        const schedule = {};
        const daysOfWeek = [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
        ];

        daysOfWeek.forEach((day) => {
          const availableCheckbox = document.getElementById(`available-${day}`);
          const startTime = document.getElementById(`start-${day}`).value;
          const endTime = document.getElementById(`end-${day}`).value;

          schedule[day] = {
            available: availableCheckbox.checked,
            hours: availableCheckbox.checked
              ? { start: startTime, end: endTime }
              : null,
          };
        });

        // Build the updated physician object
        const updatedPhysician = {
          name,
          specialty,
          bio,
          contact,
          username,
          schedule,
        };

        // If a new password was provided, update it as well
        if (password) {
          updatedPhysician.password = password;
        }

        // Update the physician in the database
        const updated = PhysicianDB.update(physicianId, updatedPhysician);

        if (updated) {
          alert("Physician information updated successfully!");
          // Update greeting with new name
          greetingElement.textContent = `Welcome, ${name}!`;
          // Close the modal
          const modalInstance = bootstrap.Modal.getInstance(
            document.getElementById("editPhysicianModal")
          );
          modalInstance.hide();
        } else {
          alert("Failed to update physician information.");
        }
      });

      // Add event listener for when the edit modal is shown
      document
        .getElementById("editPhysicianModal")
        .addEventListener("show.bs.modal", function () {
          loadPhysicianInfo();
        });
    </script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="assets/js/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
